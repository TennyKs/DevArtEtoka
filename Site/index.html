<!DOCTYPE html>
<html>
    <head>
        <meta charset="utf-8" />
        <title>Premier programme WebGL</title>
    </head>
    
    <body>
        <script src="three.js/three.js"></script>
        <script src="three.js/OrbitControls.js"></script>
        <script src="three.js/OBJLoader.js"></script>
        <script src="three.js/MTLLoader.js"></script>
        <script>
            //DB QUERY
            
            //GET ID
            
            function getXMLHttpRequest() 
            {
                var xhr = null;

                if (window.XMLHttpRequest || window.ActiveXObject) 
                {
                    if (window.ActiveXObject) 
                    {
                        try 
                        {
                            xhr = new ActiveXObject("Msxml2.XMLHTTP");
                        } catch(e) 
                        {
                            xhr = new ActiveXObject("Microsoft.XMLHTTP");
                        }
                    } else 
                    {
                        xhr = new XMLHttpRequest(); 
                    }
                } else {
                    alert("Votre navigateur ne supporte pas l'objet XMLHTTPRequest...");
                    return null;
                }
                return xhr;
            }   
            
            
            
            function Mob(group1, group2, dir)
            {
                this.group1 = group1;
                this.group2 = group2;//group.rotateX(- Math.PI).clone(true);
                this.dir = dir;
            }
            
            Mob.prototype.addScene = function()
            {
                scene.add(this.group1);
                scene.add(this.group2);
                console.log("adscene");
            }
            
            Mob.prototype.pos = function(x,y,z)
            {
                this.group1.position.set(x,y,z);
                this.group2.position.set(x,y,z);
            }
            
            function angleDiff(point1, point2, vec)
            {
                var vec2 = new THREE.Vector3
                vec2.subVectors(point2 , point1);
                
                
                
                var vecX = new THREE.Vector3(0, vec.y, vec.z);
                var vec2X = new THREE.Vector3(0, vec2.y, vec2.z);
                
                var angX;
                if(vecX.length() == 0 || vec2X.length() == 0)
                {
                    angX = 0;
                } else
                {
                    angX = vecX.angleTo(vec2X);
                }
                
                
                
                var vecY = new THREE.Vector3(vec.x, 0, vec.z);
                var vec2Y = new THREE.Vector3(vec2.x, 0, vec2.z);
                
                var angY;
                if(vecY.length() == 0 || vec2Y.length() == 0)
                {
                    angY = 0;
                } else
                {
                    angY = vecY.angleTo(vec2Y);
                }
                                
                var vecZ = new THREE.Vector3(vec.x, vec.y, 0);
                var vec2Z = new THREE.Vector3(vec2.x, vec2.y, 0);

                
                
                var angZ;
                if(vecZ.length() == 0 || vec2Z.length() == 0)
                {
                    angZ = 0;
                } else
                {
                    angZ = vecX.angleTo(vec2Z);
                }
                
                return new THREE.Vector3(angX, angY, angZ);
                
            }
            
            function mid(point1, point2)
            {
    
                var diff = new THREE.Vector3();
                diff.subVectors(point2, point1);
                //console.log(diff);
                
                
                return new THREE.Vector3().addVectors( point1 , diff.divide(new THREE.Vector3(2,2,2)) );
                
            }
            console.log("teeeeeeeeeeeeeeest");
            console.log(mid(new THREE.Vector3(0,0,0),new THREE.Vector3(1,1,1)));
            console.log("teeeeeeeeeeeeeeest");
            
            var v = new THREE.Vector3(1,1,0);
            var p1 = new THREE.Vector3(0,0,0);
            var p2 = new THREE.Vector3(0 ,0,1);
            angleDiff(p1, p2, v);
                        
            var scene = new THREE.Scene();
            scene.background = new THREE.Color("rgb(255, 255, 255)");
            
            var camera = new THREE.PerspectiveCamera( 75,window.innerWidth/window.innerHeight, 0.1, 1000 );
            var controls = new THREE.OrbitControls(camera);
            
            var renderer = new THREE.WebGLRenderer( {antialias: true} );
            renderer.setSize( window.innerWidth, window.innerHeight );
            document.body.appendChild( renderer.domElement );
            renderer.shadowMap.enabled = true;
            renderer.shadowMap.type = THREE.PCFShadowMap;
            

            
            //LOAD MODELS
            
                var mobs = new Array();//THREE.Group();
                
                var objLoader = new THREE.OBJLoader();
                objLoader.setPath('models/');
                objLoader.load('Archive.obj', function(Archive)
                {
                    //object.scale.set(1,1,10);
                    Archive.position.x = 0;
                    Archive.position.y = 0;
                    Archive.position.z = 0;
                    Archive.name = "archive";
                    
                    
                        objLoader.load('Programming.obj', function(Programming)
                        {
                            //object.scale.set(1,1,10);
                            Programming.position.x = 3;
                            Programming.position.y = 0;
                            Programming.position.z = 0;
                            Programming.name = "archive";
                            
                                objLoader.load('Picture.obj', function(Picture)
                                {
                                    //object.scale.set(1,1,10);
                                    Picture.position.x = 6;
                                    Picture.position.y = 0;
                                    Picture.position.z = 0;
                                    Picture.name = "archive";
                                    
                                        objLoader.load('Audio.obj', function(Audio)
                                        {
                                            //object.scale.set(1,1,10);
                                            Audio.position.x = 9;
                                            Audio.position.y = 0;
                                            Audio.position.z = 0;
                                            Audio.name = "archive";
                                            
                                            
                                                objLoader.load('Video.obj', function(Video)
                                                {
                                                    //object.scale.set(1,1,10);
                                                    Video.position.x = 12;
                                                    Video.position.y = 0;
                                                    Video.position.z = 0;
                                                    Video.name = "Video";
                                                    
                                                        objLoader.load('Document.obj', function(Document)
                                                        {
                                                            //object.scale.set(1,1,10);
                                                            Document.position.x = 15;
                                                            Document.position.y = 0;
                                                            Document.position.z = 0;
                                                            Document.name = "Document";
                                                            
                                                                objLoader.load('Other.obj', function(Other)
                                                                {
                                                                    //object.scale.set(1,1,10);
                                                                    Other.position.x = 15;
                                                                    Other.position.y = 0;
                                                                    Other.position.z = 0;
                                                                    Other.name = "Other";
                                                                
                                                            
                                                                        //GET DATA
                        
                                                                        var xhr1 = getXMLHttpRequest();
                                                                        
                                                                        
                                                                        xhr1.open("GET", "getDatisId.php", false);
                                                                        xhr1.send(null);
                                                                        console.log(xhr1);
                                                                        
                                                                        var ids;
                                                                        
                                                                    setTimeout(function(){
                                                                            var id = xhr1.response;
                                                                            ids = id.split('#');
                                                                            ids.pop();
                                                                        }, 2000);
                                                                        
                                                                        
                                                                        
                                                                        
                                                                        var xhr2 = getXMLHttpRequest();
                                                                        
                                                                        
                                                                        xhr2.open("GET", "getDatisData.php", false);
                                                                        xhr2.send(null);
                                                                        console.log(xhr2);
                                                                        
                                                                        var datas;
                                                                        var querys = new Array();
                                                                        
                                                                    setTimeout(function(){
                                                                            var data = xhr2.response;
                                                                            datas = data.split('#');
                                                                            datas.pop();
                                                                            for(var i in datas)
                                                                            {
                                                                                console.log(datas[i]);
                                                                                querys[i] = JSON.parse(datas[i]);
                                                                            }
                                                                            
                                                                            
                                                                            //console.log(query.data.length);
                                                                            
                                                                            //console.log(query.data[0].type);
                                                                            //console.log("querys "+querys.length);
                                                                            
                                                                            for(var i in querys)
                                                                            {
                                                                                
                                                                                
                                                                                
                                                                                var lastPos = new THREE.Vector3(0,0,0);
                                                                                var gr = new THREE.Group();
                                                                                var grMir = new THREE.Group();
                                                                                for(var j in querys[i].data)
                                                                                {
                                                                                // console.log(querys[i].data[j].type);
                                                                                for(var k =0; k < querys[i].data[j].count; k++)
                                                                                {
                                                                                    
                                                                                        var geometry = new THREE.CylinderGeometry( 0.5, 0.5, 1, 32 );
                                                                                        //var cylinder = new THREE.Mesh( geometry);
                                                                                        
                                                                                        
                                                                                                                                                                
                                                                                        
                                                                                        
//                                                                                         var x = lastPos.x + Math.random()*4 - 2;
//                                                                                         var y = lastPos.y + Math.random()*4 - 2;
//                                                                                         var z = lastPos.z + Math.random()*4;
                                                                                        var x = lastPos.x + Math.random()*2 - 1;
                                                                                        var y = lastPos.y + Math.random()*2 - 1;
                                                                                        var z = lastPos.z + Math.random()*2;
                                                                                    
                                                                                        var clone;
                                                                                        var cloneMir;
                                                                                        
                                                                                        switch ( querys[i].data[j].type )
                                                                                        {
                                                                                            case 'Video':
                                                                                                
                                                                                                
                                                                                                 clone =  Video.clone(true);
                                                                                                
                                                                                                
                                                                                            break;
                                                                                            case 'Audio':
                                                                                        
                                                                                                
                                                                                                 clone =  Audio.clone(true);
                                                                                                
                                                                                            break;
                                                                                            case 'Document':
                                                                                    
                                                                                                
                                                                                                 clone =  Document.clone(true);
                                                                                               
                                                                                            break;
                                                                                            case 'Picture':
                                                                                        
                                                                                                
                                                                                                 clone =  Picture.clone(true);
                                                                                             
                                                                                                
                                                                                            break;
                                                                                            case 'Archive':
                                                                                            
                                                                                                
                                                                                                 clone =  Archive.clone(true);
                                                                                        
                                                                                            break;
                                                                                            case 'Programming':
                                                                                            
                                                                                                
                                                                                                 clone =  Programming.clone(true);
                                                                                                                                                                                             
                                                                                            break;
                                                                                            default:
                                                                                                 clone =  Other.clone(true);
                                                                                                
                                                                                                
                                                                                                
                                                                                        }
                                                                                        
                                                                                        clone.position.set(x , y,  z);
                                                                                        gr.add(clone)
                                                                                        
                                                                                        cloneMir =  clone.clone(true);
                                                                                        cloneMir.position.set(-x , y,  z);
                                                                                        gr.add(cloneMir);
                                                                                        
//                                                                                         var middle = mid(lastPos, new THREE.Vector3(x,y,z));
//                                                                                         console.log("####################################");
//                                                                                         console.log(lastPos);
//                                                                                         console.log(new THREE.Vector3(x,y,z));
//                                                                                         console.log(middle);
//                                                                                         
//                                                                                         var bbox = new THREE.Box3().setFromObject( clone );
//                                                                                         var box = new THREE.Vector3().subVectors(bbox.max, bbox.min);
//                                                                                         console.log(box);
//                                                                                         middle.x += box.x / 2;
//                                                                                         middle.y += box.y / 2;
//                                                                                         //middle.z += box.z / 2;
//                                                                                     
//                                                                                         cylinder.position.set(middle.x, middle.y, middle.z);
//                                                                                         //cylinder.position.set(0, 0, 0);
//                                                                                         gr.add(cylinder);
                                                                                        
                                                                                        lastPos.x = x;
                                                                                        lastPos.y = y;
                                                                                        lastPos.z = z;
                                                                                    
                                                                                    }
                                                                                    
                                                                                    
                                                                                }
                                                                                
                                                                                    var x = Math.random()*20 - 10;
                                                                                    var y = Math.random()*20 - 10;
                                                                                    var z = Math.random()*20 - 10;
                                                                                            
                                                                                    var speed = Math.random()  - 0.5;
                                                                                    
                                                                                    //mobs[i].position.set(x,y,z);
                                                                                    //scene.add(mobs[i]);
                                                                                    
                                                                                    mobs[i] = new Mob(gr, grMir, new THREE.Vector3(speed  ,0,0));
                                                                                    mobs[i].pos(x,y,z);
                                                                                    mobs[i].addScene();
                                                                                    
                                                                            }
                                                                            
                                                                    
                                                                            //scene.add(mob);
                                                                            //mob.position.set(0, 5, -5);
                                                                            
                                                                            
                                                                        }, 2000);
                                                            
                                                            
                                                            }
                                                        
                                                            , function(xhr)
                                                            {
                                                                console.log((xhr.loaded / xhr.total * 100) + ' %loaded');
                                                            }, function(error)
                                                            {
                                                                console.error("erreur de chargement");
                                                            });
                                                            
                                                            
                                                        }
                                                        
                                                        , function(xhr)
                                                        {
                                                            console.log((xhr.loaded / xhr.total * 100) + ' %loaded');
                                                        }, function(error)
                                                        {
                                                            console.error("erreur de chargement");
                                                        });
                                                    
                                                }
                                                
                                                , function(xhr)
                                                {
                                                    console.log((xhr.loaded / xhr.total * 100) + ' %loaded');
                                                }, function(error)
                                                {
                                                    console.error("erreur de chargement");
                                                });
                                            
                                        }
                                        
                                        , function(xhr)
                                        {
                                            console.log((xhr.loaded / xhr.total * 100) + ' %loaded');
                                        }, function(error)
                                        {
                                            console.error("erreur de chargement");
                                        });
                                    
                                }
                                
                                , function(xhr)
                                {
                                    console.log((xhr.loaded / xhr.total * 100) + ' %loaded');
                                }, function(error)
                                {
                                    console.error("erreur de chargement");
                                });
                            
                        }
                        
                        , function(xhr)
                        {
                            console.log((xhr.loaded / xhr.total * 100) + ' %loaded');
                        }, function(error)
                        {
                            console.error("erreur de chargement");
                        });
                    
                }
                
                , function(xhr)
                {
                    console.log((xhr.loaded / xhr.total * 100) + ' %loaded');
                }, function(error)
                {
                    console.error("erreur de chargement");
                });
            
            
        
            
            //LIGHT
            var lumiere = new THREE.AmbientLight(0x555555);
            scene.add(lumiere);
            var lumiereDir = new THREE.DirectionalLight(0xffffff);
            lumiereDir.position.set(1, 1, 1);
            
            lumiereDir.castShadow = true;
            lumiereDir.shadow.width = 2048;
            lumiereDir.shadow.height = 2048;
            lumiereDir.shadow.camera.top = 20;
            lumiereDir.shadow.camera.bottom = -20;
            lumiereDir.shadow.camera.left = -20.5;
            lumiereDir.shadow.camera.right = 20.5;
            lumiereDir.shadow.camera.far = 500.75;
            lumiereDir.shadow.bias = -0.025;
            
            scene.add(lumiereDir);
            
            //HELPERS
            var axesHelper = new THREE.AxesHelper(5);
            scene.add(axesHelper);
            
            var size = 20;
            var divisions = 10;
            var gridHelper = new THREE.GridHelper(size, divisions);
            scene.add(gridHelper)
            
            camera.position.set( 0, 0, 8 );
            
            window.addEventListener("keydown", 
            function(event){
                switch (event.key){
                case "a":
                    axesHelper.visible = !axesHelper.visible;
                break;
                case "g":
                    gridHelper.visible = !gridHelper.visible;
                break;
                }
                event.preventDefault();
            }, true);
            
            var t = 0;
            var direction = new THREE.Vector3(0.05, 0,0);
            for(var i in mobs)
            {
            
            }
            var animate = function () {
            requestAnimationFrame( animate );
            
            
            
            for(var i in mobs)
            {
            mobs[i].group1.position.set(mobs[i].group1.position.x + mobs[i].dir.x,mobs[i].group1.position.y +  mobs[i].dir.y ,mobs[i].group1.position.z + mobs[i].dir.z);
            mobs[i].dir.applyAxisAngle(new THREE.Vector3(0,1,0), mobs[i].dir.length()/30);
            mobs[i].group1.lookAt(mobs[i].group1.position.x + mobs[i].dir.x,mobs[i].group1.position.y +  mobs[i].dir.y ,mobs[i].group1.position.z + mobs[i].dir.z);
            }
            
            
            t+= 0.001;
            renderer.render( scene, camera );
            
            };
            animate();
        </script>
    </body>
</html>
