<!DOCTYPE html>
<html>
    <head>
        <meta charset="utf-8" />
        <title>Premier programme WebGL</title>
    </head>
    
    <body>
        <script src="three.js/three.js"></script>
        <script src="three.js/OrbitControls.js"></script>
        <script src="three.js/OBJLoader.js"></script>
        <script src="three.js/MTLLoader.js"></script>
        <script>
            //DB QUERY
            
            //GET ID
            
            function getXMLHttpRequest() 
            {
                var xhr = null;

                if (window.XMLHttpRequest || window.ActiveXObject) 
                {
                    if (window.ActiveXObject) 
                    {
                        try 
                        {
                            xhr = new ActiveXObject("Msxml2.XMLHTTP");
                        } catch(e) 
                        {
                            xhr = new ActiveXObject("Microsoft.XMLHTTP");
                        }
                    } else 
                    {
                        xhr = new XMLHttpRequest(); 
                    }
                } else {
                    alert("Votre navigateur ne supporte pas l'objet XMLHTTPRequest...");
                    return null;
                }
                return xhr;
            }   
            
            
            
            function Mob(group1, group2)
            {
                this.group1 = group1;
                this.group2 = group2;//group.rotateX(- Math.PI).clone(true);
            }
            
            Mob.prototype.addScene = function()
            {
                scene.add(this.group1);
                scene.add(this.group2);
                console.log("adscene");
            }
            
            Mob.prototype.pos = function(x,y,z)
            {
                this.group1.position.set(x,y,z);
                this.group2.position.set(x,y,z);
            }
            
            
                        
            var scene = new THREE.Scene();
            scene.background = new THREE.Color("rgb(255, 255, 255)");
            
            var camera = new THREE.PerspectiveCamera( 75,window.innerWidth/window.innerHeight, 0.1, 1000 );
            var controls = new THREE.OrbitControls(camera);
            
            var renderer = new THREE.WebGLRenderer( {antialias: true} );
            renderer.setSize( window.innerWidth, window.innerHeight );
            document.body.appendChild( renderer.domElement );
            renderer.shadowMap.enabled = true;
            renderer.shadowMap.type = THREE.PCFShadowMap;
            

            
            //LOAD MODELS
            
                var mobs = new Array();//THREE.Group();
                
                var objLoader = new THREE.OBJLoader();
                objLoader.setPath('models/');
                objLoader.load('Archive.obj', function(Archive)
                {
                    //object.scale.set(1,1,10);
                    Archive.position.x = 0;
                    Archive.position.y = 0;
                    Archive.position.z = 0;
                    Archive.name = "archive";
                    
                    
                        objLoader.load('Programming.obj', function(Programming)
                        {
                            //object.scale.set(1,1,10);
                            Programming.position.x = 3;
                            Programming.position.y = 0;
                            Programming.position.z = 0;
                            Programming.name = "archive";
                            
                                objLoader.load('Picture.obj', function(Picture)
                                {
                                    //object.scale.set(1,1,10);
                                    Picture.position.x = 6;
                                    Picture.position.y = 0;
                                    Picture.position.z = 0;
                                    Picture.name = "archive";
                                    
                                        objLoader.load('Audio.obj', function(Audio)
                                        {
                                            //object.scale.set(1,1,10);
                                            Audio.position.x = 9;
                                            Audio.position.y = 0;
                                            Audio.position.z = 0;
                                            Audio.name = "archive";
                                            
                                            
                                                objLoader.load('Video.obj', function(Video)
                                                {
                                                    //object.scale.set(1,1,10);
                                                    Video.position.x = 12;
                                                    Video.position.y = 0;
                                                    Video.position.z = 0;
                                                    Video.name = "Video";
                                                    
                                                        objLoader.load('Document.obj', function(Document)
                                                        {
                                                            //object.scale.set(1,1,10);
                                                            Document.position.x = 15;
                                                            Document.position.y = 0;
                                                            Document.position.z = 0;
                                                            Document.name = "Document";
                                                            
                                                            
                                                            
                                                            
                                                            //GET DATA
            
                                                            var xhr1 = getXMLHttpRequest();
                                                            
                                                            
                                                            xhr1.open("GET", "getDatisId.php", false);
                                                            xhr1.send(null);
                                                            console.log(xhr1);
                                                            
                                                            var ids;
                                                            
                                                        setTimeout(function(){
                                                                var id = xhr1.response;
                                                                ids = id.split('#');
                                                                ids.pop();
                                                            }, 2000);
                                                            
                                                            
                                                            
                                                            
                                                            var xhr2 = getXMLHttpRequest();
                                                            
                                                            
                                                            xhr2.open("GET", "getDatisData.php", false);
                                                            xhr2.send(null);
                                                            console.log(xhr2);
                                                            
                                                            var datas;
                                                            var querys = new Array();
                                                            
                                                        setTimeout(function(){
                                                                var data = xhr2.response;
                                                                datas = data.split('#');
                                                                datas.pop();
                                                                for(var i in datas)
                                                                {
                                                                    console.log(datas[i]);
                                                                    querys[i] = JSON.parse(datas[i]);
                                                                }
                                                                
                                                                
                                                                //console.log(query.data.length);
                                                                
                                                                //console.log(query.data[0].type);
                                                                //console.log("querys "+querys.length);
                                                                
                                                                for(var i in querys)
                                                                {
                                                                    var lastPos = new THREE.Vector3(0,0,0);
                                                                    var gr = new THREE.Group();
                                                                    var grMir = new THREE.Group();
                                                                    for(var j in querys[i].data)
                                                                    {
                                                                       // console.log(querys[i].data[j].type);
                                                                        console.log(typeof(querys[i].data[j].type));
                                                                        
                                                                        lastPos.x += Math.random()*4 - 2;
                                                                        lastPos.y += Math.random()*4 - 2;
                                                                        lastPos.z += Math.random()*4 ;
                                                                        
                                                                        console.log(lastPos);
                                                                        
                                                                        var x = lastPos.x ;
                                                                        var y = lastPos.y ;
                                                                        var z = lastPos.z ;
                                                                        switch ( querys[i].data[j].type )
                                                                        {
                                                                            case 'Video':
                                                                                
                                                                                
                                                                                var clone =  Video.clone(true);
                                                                                clone.position.set(x , y,  z);
                                                                                
                                                                                gr.add(clone)
                                                                                
                                                                                var cloneMir =  Video.clone(true);
                                                                                cloneMir.position.set(-x , y,  z);
                                                                                
                                                                                grMir.add(cloneMir)
                                                                                
                                                                            break;
                                                                            case 'Audio':
                                                                          
                                                                                
                                                                                var clone =  Audio.clone(true);
                                                                                clone.position.set(x , y,  z);
                                                                                gr.add(clone)
                                                                                
                                                                                var cloneMir =  Audio.clone(true);
                                                                                cloneMir.position.set(-x , y,  z);
                                                                                
                                                                                grMir.add(cloneMir)
                                                                            break;
                                                                            case 'Document':
                                                                      
                                                                                
                                                                                var clone =  Document.clone(true);
                                                                                clone.position.set(x , y,  z);
                                                                                gr.add(clone)
                                                                                
                                                                                var cloneMir =  Document.clone(true);
                                                                                cloneMir.position.set(-x , y,  z);
                                                                                
                                                                                grMir.add(cloneMir)
                                                                            break;
                                                                            case 'Picture':
                                                                          
                                                                                
                                                                                var clone =  Picture.clone(true);
                                                                                clone.position.set(x , y,  z);
                                                                                gr.add(clone)
                                                                                
                                                                                var cloneMir =  Picture.clone(true);
                                                                                cloneMir.position.set(-x , y,  z);
                                                                                
                                                                                grMir.add(cloneMir)
                                                                                
                                                                            break;
                                                                            case 'Archive':
                                                                              
                                                                                
                                                                                var clone =  Archive.clone(true);
                                                                                clone.position.set(x , y,  z);
                                                                                gr.add(clone)
                                                                                
                                                                                var cloneMir =  Archive.clone(true);
                                                                                cloneMir.position.set(-x , y,  z);
                                                                                
                                                                                grMir.add(cloneMir)
                                                                            break;
                                                                            case 'Programming':
                                                                               
                                                                                
                                                                                var clone =  Programming.clone(true);
                                                                                clone.position.set(x , y,  z);
                                                                                gr.add(clone)
                                                                                
                                                                                var cloneMir =  Programming.clone(true);
                                                                                cloneMir.position.set(-x , y,  z);
                                                                                
                                                                                grMir.add(cloneMir)
                                                                            break;
                                                                            case 'Other':
                                                                                
                                                                            break;
                                                                            default:
                                                                        }
                                                                        
                                                                        
                                                                        
                                                                        
                                                                    }
                                                                    
                                                                        var x = Math.random()*10 - 5;
                                                                        var y = Math.random()*10 - 5;
                                                                        var z = Math.random()*10 - 5;
                                                                                
                                                                        
                                                                        //mobs[i].position.set(x,y,z);
                                                                        //scene.add(mobs[i]);
                                                                        
                                                                        mobs[i] = new Mob(gr, grMir);
                                                                        mobs[i].pos(x,y,z);
                                                                        mobs[i].addScene();
                                                                }
                                                                
                                                           
                                                                //scene.add(mob);
                                                                //mob.position.set(0, 5, -5);
                                                                
                                                                
                                                            }, 2000);
                                                            
                                                            

                                                            
                                                            
                                                        }
                                                        
                                                        , function(xhr)
                                                        {
                                                            console.log((xhr.loaded / xhr.total * 100) + ' %loaded');
                                                        }, function(error)
                                                        {
                                                            console.error("erreur de chargement");
                                                        });
                                                    
                                                }
                                                
                                                , function(xhr)
                                                {
                                                    console.log((xhr.loaded / xhr.total * 100) + ' %loaded');
                                                }, function(error)
                                                {
                                                    console.error("erreur de chargement");
                                                });
                                            
                                        }
                                        
                                        , function(xhr)
                                        {
                                            console.log((xhr.loaded / xhr.total * 100) + ' %loaded');
                                        }, function(error)
                                        {
                                            console.error("erreur de chargement");
                                        });
                                    
                                }
                                
                                , function(xhr)
                                {
                                    console.log((xhr.loaded / xhr.total * 100) + ' %loaded');
                                }, function(error)
                                {
                                    console.error("erreur de chargement");
                                });
                            
                        }
                        
                        , function(xhr)
                        {
                            console.log((xhr.loaded / xhr.total * 100) + ' %loaded');
                        }, function(error)
                        {
                            console.error("erreur de chargement");
                        });
                    
                }
                
                , function(xhr)
                {
                    console.log((xhr.loaded / xhr.total * 100) + ' %loaded');
                }, function(error)
                {
                    console.error("erreur de chargement");
                });
            
            
        
            
            //LIGHT
            var lumiere = new THREE.AmbientLight(0x555555);
            scene.add(lumiere);
            var lumiereDir = new THREE.DirectionalLight(0xffffff);
            lumiereDir.position.set(1, 1, 1);
            
            lumiereDir.castShadow = true;
            lumiereDir.shadow.width = 2048;
            lumiereDir.shadow.height = 2048;
            lumiereDir.shadow.camera.top = 20;
            lumiereDir.shadow.camera.bottom = -20;
            lumiereDir.shadow.camera.left = -20.5;
            lumiereDir.shadow.camera.right = 20.5;
            lumiereDir.shadow.camera.far = 500.75;
            lumiereDir.shadow.bias = -0.025;
            
            scene.add(lumiereDir);
            
            //HELPERS
            var axesHelper = new THREE.AxesHelper(5);
            scene.add(axesHelper);
            
            var size = 20;
            var divisions = 10;
            var gridHelper = new THREE.GridHelper(size, divisions);
            scene.add(gridHelper)
            
            camera.position.set( 0, 0, 8 );
            
            window.addEventListener("keydown", 
            function(event){
                switch (event.key){
                case "a":
                    axesHelper.visible = !axesHelper.visible;
                break;
                case "g":
                    gridHelper.visible = !gridHelper.visible;
                break;
                }
                event.preventDefault();
            }, true);
            
            var animate = function () {
            requestAnimationFrame( animate );
            
            //cube.rotation.x += 0.01;
            //cube.rotation.y += 0.01;
            
            renderer.render( scene, camera );
            
            };
            animate();
        </script>
    </body>
</html>
